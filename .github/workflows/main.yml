name: Test CI/CD
on: workflow_dispatch
    # push:
    #     branches:
    #         - release
jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - name: Get repository code
              uses: actions/checkout@v4
            - name: Cache dependencies # Добавляется перед каждой установкой зависимостей, чтобы ускорить установку
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: python-dependencies-${{ hashFiles('**/poetry.lock')}}
            - name: Install dependencies
              run: poetry install --with dev,test
            - name: Test app
              run: poetry test
    
    build:
        needs: test
        strategy:
            matrix:
                os: [ubuntu-latest, windows-latest]
                python-version: [ '3.12.1' ] # ['3.12.1', '3.12.2']
        
        runs-on: ${{ matrix.os }}
        steps:
            - name: Get repository code
              uses: actions/checkout@v4
            - name: Cache dependencies # Добавляется перед каждой установкой зависимостей, чтобы ускорить установку
              uses: actions/cache@v4
              with:
                path: ~/.npm
                key: python-dependencies-${{ hashFiles('**/poetry.lock')}}
            - name: Install python
              uses: actions/setup-python@v5 
              with:
                python-version: ${{ matrix.python-version }} 
            - name: Poetry Install
              uses: Gr1N/setup-poetry@v8
            - run: poetry --version
            - name: Install dependencies
              run: poetry install --with dev,test
            - run: python my_script.py

            # именно тута, да
            #- name: Upload Artifact
            #  uses: actions/upload-artifact@v3
            #  with:
            #    path: build
            #    name: build-files

    # Скачивает артифакты, которые мы выгрузили в прошлой job-е
    deploy:
        needs: build
        runs-on: ubuntu-latest
        steps:
            - name: Get build project
              uses: actions/download-artifact@v3
              with:
                name: build-files


